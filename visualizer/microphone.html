<!--
FILENAME: microphone.html
AUTHOR: Hank Wikle
LAST MODIFIED: 4 June 2018
-->

<!DOCTYPE html>
<meta charset="UTF-8">

<html>

<div id='modeldiv'></div>

<script type='module'>

    import { Visualizer } from './visualizer.js'

    const BINS = 16; // Must be a power of two between 16 and 16384 (inclusive)
    const viz = new Visualizer(document.body, { minX: 0, maxX: BINS - 1, minY: -10, maxY: 10 });

    // window.onload = function () {

    // Set up audio context

    const ctx = new AudioContext();
    const constraints = { audio: true };
    var source;
    const analyser = ctx.createAnalyser();
    analyser.fftSize = 2 * BINS;

    const freqData = new Uint8Array(analyser.frequencyBinCount);
    viz.setup(freqData);
    viz.start()
    function renderFrame() {
        requestAnimationFrame(renderFrame);
        analyser.getByteFrequencyData(freqData);
        //viz.buffer = freqData
        viz.step()
    }

    let handleSuccess = function (stream) {
        source = ctx.createMediaStreamSource(stream);
        source.connect(analyser);
        renderFrame();
    };

    navigator.mediaDevices.getUserMedia(constraints)
        .then(handleSuccess);
   //  }
</script>

</html>