<!--
FILENAME: microphone.html
AUTHOR: Hank Wikle
LAST MODIFIED: 5 June 2018
-->

<!DOCTYPE html>
<meta charset="UTF-8">

<html>
    <head>
    <script src="https://unpkg.com/@redfish/as-app3d"></script>
    <script src="https://unpkg.com/@redfish/agentscript"></script>
    <script src="./visualizer.js"></script>
    <script>
        const NUM_BINS = 16; // Must be a power of two between 16 and 16384 (inclusive)

        var model = new Model();
        var freqData = new Uint8Array(NUM_BINS);
        var viz = new Visualizer();
        viz.setup(freqData);

        window.onload = function() {

            // Set up audio context

            const ctx = new AudioContext();
            const constraints = {audio: true};
            var source;
            const analyser = ctx.createAnalyser();
            analyser.fftSize = 2*NUM_BINS;
            
            function renderFrame() {
                requestAnimationFrame(renderFrame);
                analyser.getByteFrequencyData(freqData);
                viz.step();
            }

            let handleSuccess = function(stream) {
                source = ctx.createMediaStreamSource(stream);
                source.connect(analyser);
                renderFrame();
            };

            navigator.mediaDevices.getUserMedia(constraints).then(handleSuccess);
        }
    </script></head>
    <body>
        <div id="modeldiv"></div>
    </body>
</html>
